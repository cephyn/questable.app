# For AI coding agents â€” Questable / quest_cards

Short, practical guide so an AI agent can be immediately productive in this repo.

Quick start
- App: Flutter multi-platform app under [lib/](../lib) (entry: [lib/main.dart](../lib/main.dart)).
- Shell app + routing: [lib/src/app.dart](../lib/src/app.dart) defines `MyApp`, `HomePage`, navigation, and admin destinations.
- Backend: Firebase Cloud Functions (Python) under [functions/](../functions) (entry: [functions/main.py](../functions/main.py)).
- Legacy/auxiliary Node functions: [functions_node/index.js](../functions_node/index.js).
- Analysis scripts: [analysis_scripts/](../analysis_scripts) (Node scripts for data analysis; see [analysis_scripts/package.json](../analysis_scripts/package.json)).

Architecture (big picture)
- Frontend: Flutter UI uses `GoRouter` configured in [lib/main.dart](../lib/main.dart) with auth redirects based on `AuthProvider` ([lib/src/providers/auth_provider.dart](../lib/src/providers/auth_provider.dart)). Actual UI scaffolding, navigation rail, and admin tools live in [lib/src/app.dart](../lib/src/app.dart).
- Auth: Firebase Auth wrapped by [lib/src/services/firebase_auth_service.dart](../lib/src/services/firebase_auth_service.dart) and exposed via `AuthProvider`. `HomePage` shows a public quest list when logged out and an adaptive, role-based nav when logged in.
- Backend: Python Cloud Functions in [functions/main.py](../functions/main.py) handle Firestore triggers, callable HTTPS functions (search, config, proxy), similarity computation trigger, and search index maintenance.
- Data: Primary data is Firestore collection `questCards`; similar quests are stored in subcollection `similarQuests` per quest. Search candidates are stored in `questSearchIndex` documents maintained by [functions/indexer.py](../functions/indexer.py).

Key patterns & conventions
- Firebase config is generated by FlutterFire; web is wired via [lib/firebase_options.dart](../lib/firebase_options.dart). Re-run FlutterFire CLI when adding platforms instead of hand-editing.
- GoRouter redirect logic depends on `AuthProvider` being available before `runApp`; see [lib/main.dart](../lib/main.dart) for initialization order and keep that pattern.
- App state uses Provider + `ChangeNotifier` (e.g., `SettingsController`, `AuthProvider`, `FilterProvider`, `UserContext`); when adding stateful services, follow the same provider pattern and wire them in [lib/src/app.dart](../lib/src/app.dart) or [lib/main.dart](../lib/main.dart).
- Cloud Functions avoid heavy imports at module import time. For NLTK/scikit-learn and other large libs, use lazy imports inside functions (see [functions/similarity_calculator.py](../functions/similarity_calculator.py) and `calculate_similarity_for_quest`).
- NLTK data must be pre-packaged under [functions/nltk_data/](../functions/nltk_data) (unzipped `punkt`, `punkt_tab`, `stopwords`) before deploying similarity code; see `_setup_nltk_data_for_packaging` in [functions/similarity_calculator.py](../functions/similarity_calculator.py).
- Search: callable `search_quests` in [functions/main.py](../functions/main.py) uses [functions/search.py](../functions/search.py) plus token-based candidates from `questSearchIndex` via [functions/indexer.py](../functions/indexer.py). Keep new search features within that pipeline.

Essential commands (local dev & CI)
- Install Flutter deps: `flutter pub get` (run at repo root).
- Install Python function deps (Windows): `python -m venv .venv && .venv\Scripts\activate && pip install -r functions/requirements.txt`.
- Install analysis script deps: `cd analysis_scripts && npm install`.
- Run app locally (web): `flutter run -d chrome`.
- Build web for hosting: `flutter build web --no-tree-shake-icons`.
- Firebase Hosting deploy: `firebase deploy --only hosting` (or `firebase hosting:channel:deploy preview_build --project quest-cards-3c47a` for preview).
- Deploy Python functions: `firebase deploy --only functions` (ensure [functions/nltk_data/](../functions/nltk_data) is present if NLP code changed).
- Run Flutter tests: `flutter test` (see [test/](../test) for examples).
- Run Python tests for functions: from [functions/](../functions) run `pytest` (tests live in `test_*.py`).
- Use Firebase emulators for local Firestore/Auth/Functions: `firebase emulators:start` (after `firebase init emulators`).

Repo-specific gotchas
- Do not assume [lib/firebase_options.dart](../lib/firebase_options.dart) covers all platforms; regenerate via FlutterFire when enabling new platforms.
- When touching similarity or NLP code, keep `firebase_admin` initialization idempotent using the existing `_initialize_firebase` pattern in [functions/similarity_calculator.py](../functions/similarity_calculator.py) and the top-level `initialize_app()` in [functions/main.py](../functions/main.py).
- `search_quests` relies on `questSearchIndex`; when changing index structure, update both [functions/indexer.py](../functions/indexer.py) and [functions/main.py](../functions/main.py) (including `maintain_search_index` and `backfill_search_index`).
- Admin-only views (user list, migration tools, purchase link backfill, game system admin) are surfaced via destinations in `HomePage` in [lib/src/app.dart](../lib/src/app.dart) and gated by Firestore roles; keep new admin tools consistent with that pattern.

Where to look for examples
- UI + routing and shell: [lib/main.dart](../lib/main.dart), [lib/src/app.dart](../lib/src/app.dart).
- Auth flow and profile access: [lib/src/providers/auth_provider.dart](../lib/src/providers/auth_provider.dart), [lib/src/services/firebase_auth_service.dart](../lib/src/services/firebase_auth_service.dart), [lib/src/screens/profile_screen.dart](../lib/src/screens/profile_screen.dart).
- Quest lists, search, and details: [lib/src/quest_card/public_quest_card_list_view.dart](../lib/src/quest_card/public_quest_card_list_view.dart), [lib/src/quest_card/quest_card_list_view.dart](../lib/src/quest_card/quest_card_list_view.dart), [lib/src/quest_card/quest_card_search.dart](../lib/src/quest_card/quest_card_search.dart), [lib/src/quest_card/quest_card_details_view.dart](../lib/src/quest_card/quest_card_details_view.dart).
- Cloud Functions triggers, similarity, and search index: [functions/main.py](../functions/main.py), [functions/similarity_calculator.py](../functions/similarity_calculator.py), [functions/search.py](../functions/search.py), [functions/indexer.py](../functions/indexer.py).

If something's unclear
- Ask for the exact task, reference a small example file to modify, and whether to run the app, tests, or a Firebase deploy/preview. Include any shell commands you want the human to run.

Keep this file concise and repo-specific; avoid generic best practices or non-existent patterns.
