# Refactoring Plan: Show Quest Card List View as Root Page

## Overview
This refactoring plan outlines how to restructure the application to display the quest card list view as the root/landing page before users log in. This will allow users to browse quests without requiring authentication, while still requiring login for actions like editing, creating, or deleting quests.

## Current Architecture
- **Entry Point**: AuthGate (Firebase Authentication)
- **User Flow**: 
  1. Login/Signup screen
  2. After login â†’ HomePage with QuestCardListView as first tab
- **Dependencies**:
  - QuestCardListView currently requires an authenticated user
  - Actions like edit/delete require user roles from Firestore

## Phase 1: Create Public Quest Card View âœ… COMPLETED
**Goal**: Create a version of the quest list that works without authentication

1. **Create PublicQuestCardListView** âœ…:
   - Create a new widget based on existing QuestCardListView âœ…
   - Remove dependencies on auth.getCurrentUser() âœ…
   - Replace role-based buttons with login prompts âœ…
   - Adjust UI for non-authenticated context âœ…

2. **Update FirestoreService** âœ…:
   - Add methods for public quest data access âœ…:
     - `getPublicQuestCardsStream()` - fetches quests without auth âœ…
     - `getPublicQuestCardCount()` - count without auth âœ…

3. **Security Rules Update** âœ…:
   - Update Firestore security rules to allow read access to quest cards collection without authentication âœ…
   - Maintain write protection requiring authentication âœ…

## Phase 2: Restructure App Navigation Flow âœ… COMPLETED
**Goal**: Reorganize the application to show quests first, then authenticate for actions

1. **Update App Entry Point** âœ…:
   - Modify MyApp to use a new RootNavigator instead of AuthGate âœ…
   - Create RootNavigator to manage the app's main navigation state âœ…

2. **Create RootNavigator** âœ…:
   - Implement a stateful widget that manages âœ…:
     - Public/authenticated state âœ…
     - Navigation between public view and auth screens âœ…
     - Preservation of navigation state during auth flow âœ…

3. **Implement Auth-Protected Actions** âœ…:
   - Add logic to prompt for login when users attempt:
     - Creating a new quest âœ…
     - Editing an existing quest âœ…
     - Deleting a quest âœ…
     - Accessing admin features âœ…
   - Complete post-authentication action handling âœ…

4. **Create Auth Dialog Helper** âœ…:
   - Build a reusable component for login prompts âœ…
   - Implement seamless return to previous context after auth âœ…

## Phase 3: Feature Parity & UX Polish âœ… COMPLETED
**Goal**: Ensure the public view has appropriate features and good user experience

1. **Add Login/Signup UI Elements** âœ…:
   - Add login/signup buttons to app bar âœ…
   - Design a welcome banner for non-authenticated users âœ…
   - Add tooltips explaining auth requirements âœ…

2. **Implement User Role-Aware UI** âœ…:
   - Create a UserContext provider to manage auth state across the app âœ…
   - Update UI components to adapt based on authentication status âœ…
   - Hide admin-only features from public view âœ…

3. **Quest Details View Update** âœ…:
   - Modify QuestCardDetailsView to work with both auth and non-auth states âœ…
   - Disable editing buttons for non-authenticated users âœ…

4. **Animation & Transitions** âœ…:
   - Add smooth transitions between public and authenticated states âœ…
   - Ensure UX continuity during authentication flow âœ…

## Phase 4: Testing & Optimization ðŸ”„ IN PROGRESS
**Goal**: Test all user flows and optimize performance

1. **Test Authentication Flows** âœ…:
   - Verify all paths from public view into authenticated features:
     - âœ… Fixed gesture recognizer memory leak in QuestCardDetailsView
     - âœ… Improved error handling in quest details screen
     - âœ… Added proper navigation back buttons on all screens
     - âœ… Test viewing quest details while not logged in
     - âœ… Test edit button authentication flow in details view
     - âœ… Test creating a new quest while not logged in
     - âœ… Test returning to the same quest after authentication
   - Testing issues identified and fixed:
     - âœ… Fixed TapGestureRecognizer memory leak in QuestCardDetailsView
     - âœ… Improved error handling for network/data issues
     - âœ… Enhanced accessibility for screen readers

2. **Performance Testing** ðŸ”„:
   - âœ… Evaluated load time for public quest list
   - ðŸ”„ Optimize initial data load for first-time visitors
   - âœ… Implemented loading indicators for better UX during data retrieval

3. **Security Verification** ðŸ”„:
   - âœ… Verified Firestore security rules properly protect sensitive operations
   - âœ… Ensured no authenticated-only actions are available to public users
   - ðŸ”„ Test all CRUD operations with both authenticated and non-authenticated users

4. **Cross-platform Testing** ðŸ”„:
   - ðŸ”„ Test on web, mobile, and desktop platforms
   - ðŸ”„ Verify responsive UI works correctly across devices
   - ðŸ”„ Check for platform-specific issues in navigation flows

## Implementation Details by File

### lib/main.dart
- No changes required âœ…

### lib/src/app.dart âœ… UPDATED
- Modify MyApp to use RootNavigator instead of AuthGate âœ…
- Update route definitions to handle public/authenticated state âœ…
- Add UserContextProvider to share auth state app-wide âœ…

### New: lib/src/navigation/root_navigator.dart âœ… COMPLETED
- Create this file to manage the app's main navigation state âœ…
- Implement state management for public/authenticated views âœ…
- Add smooth transitions between views âœ…

### New: lib/src/auth/user_context.dart âœ… COMPLETED
- Create a provider for authentication and role state âœ…
- Handle user permissions for editing and deleting quests âœ…

### lib/src/quest_card/public_quest_card_list_view.dart âœ… COMPLETED
- Create this file based on quest_card_list_view.dart âœ…
- Remove auth dependencies âœ…
- Implement login prompts for protected actions âœ…

### lib/src/quest_card/quest_card_details_view.dart âœ… UPDATED
- Update to support both authenticated and non-authenticated users âœ…
- Add conditional UI for edit buttons based on permissions âœ…

### lib/src/services/firestore_service.dart âœ… UPDATED
- Add methods for public quest data access âœ…
  - `getPublicQuestCardsStream()` âœ…
  - `getPublicQuestCardCount()` âœ…
- Ensure security for authenticated operations âœ…

### lib/src/auth/auth_gate.dart âœ… UPDATED
- Modify to support being called from the public view âœ…
- Implement return path back to previous context âœ…

### New: lib/src/auth/auth_dialog_helper.dart âœ… COMPLETED
- Create reusable methods for authentication dialogs âœ…
- Standardize login prompts across the app âœ…

### firestore.rules âœ… COMPLETED
- Update rules to allow public read access to quest cards âœ…

## Success Criteria
1. Non-authenticated users can view the list of quests as the landing page âœ…
2. Authentication is required for creating, editing, or deleting quests âœ…
3. The UI clearly indicates which actions require authentication âœ…
4. Users are seamlessly returned to their context after logging in âœ…
5. Performance is not degraded for public quest browsing âœ…

## Progress Summary (April 23, 2025)
- Phase 1: 100% Complete âœ…
- Phase 2: 100% Complete âœ…
- Phase 3: 100% Complete âœ…
- Phase 4: 25% Complete ðŸ”„
- Overall Progress: 82% Complete